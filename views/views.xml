<openerp>
  <data>

    <!-- Comercio -->

    <record id="entidad_form_inherited"  model="ir.ui.view">
      <field name="name">Extension Entidad Form</field>
      <field name="model">financiera.entidad</field>
      <field name="inherit_id" ref="financiera_base.financiera_entidad_form"/>
      <field name="arch" type="xml">        
        <xpath expr="//field[@name='type']" position="after">
          <field name="father_id" domain="[('type', '=', 'comercio')]" attrs="{'invisible': [('type', '!=', 'comercio')]}"/>
        </xpath>
      </field>
    </record>


    <record model="ir.actions.act_window" id="financiera_comercio_action">
      <field name="name">Comercios</field>
      <field name="res_model">financiera.entidad</field>
      <field name="view_mode">tree,form</field>
      <field name="context">{'default_type': 'comercio'}</field>
      <field name="domain">[('type','=', 'comercio')]</field>
      <field name="view_ids" eval="[(5, 0, 0), 
        (0, 0, {'view_mode': 'tree', 'view_id': ref('financiera_base.financiera_entidad_tree')}),
        (0, 0, {'view_mode': 'form', 'view_id': ref('financiera_base.financiera_entidad_form')})]
        "/>
    </record>

    <menuitem name="Entidades" id="financiera_base.menu_sucursales" web_icon="financiera_base,static/description/entidad.png"/>

    <menuitem name="Comercios" id="menu_comercios_action" parent="financiera_base.menu_sucursales" 
      action="financiera_comercio_action"/>

    <!-- Vista Solicitud -->

    <record model="ir.ui.view" id="financiera_solicitud_tree">
      <field name="name">Solicitud</field>
      <field name="model">financiera.solicitud</field>
      <field name="arch" type="xml">
        <tree decoration-info="state in ['send', 'processing']" decoration-success="state == 'open'" decoration-muted="state in ['confirm', 'cancel']">
          <field name="name"/>
          <field name="partner_id"/>
          <field name="amount"/>
          <field name="comercio_id"/>
          <field name="asigned_id"/>
          <field name="send_minutes"/>
          <field name="process_minutes"/>
          <field name="asigned_id"/>
          <field name="state"/>
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="filter_financiera_solicitud_tree">
      <field name="name">financiera.solicitud.filter</field>
      <field name="model">financiera.solicitud</field>
      <field name="arch" type="xml">
        <search>
          <filter string="Pendientes" groups="financiera_comercio.manager" name="pendientes" domain="[('state','in', ('send', 'processing'))]"/>
          <separator/>
          <filter string="Mis asignadas" groups="financiera_comercio.manager" name="mis_solicitudes" domain="[('asigned_id','=', uid)]"/>
          <separator/>
          <field name="name"/>
          <field name="partner_id"/>
          <field name="comercio_id"/>
          <field name="asigned_id"/>
          <field name="state"/>
        </search>
      </field>
    </record>
    
    <record id="financiera_solicitud_form" model="ir.ui.view">
      <field name="name">Financiera solicitud form</field>
      <field name="model">financiera.solicitud</field>
      <field name="arch" type="xml">
        <header>
          <button name="send" class="oe_highlight" states="draft" string="Enviar" type="object"/>
          <button name="processing" class="oe_highlight" states="send" string="Procesar" type="object" groups="financiera_comercio.process_prestamo" />
          <button name="open" class="oe_highlight" states="processing" string="Validar Solicitud" type="object" groups="financiera_comercio.process_prestamo" />
          <button name="confirm" class="oe_highlight" states="open" string="Confirmar" type="object"/>
          <button name="draft" string="A borrador" type="object"/>
          <button name="cancel" states="send,processing,open" string="Cancelar Solicitud" type="object"/>
          <field name="state" readonly="0" editable="1" widget="statusbar"/>
        </header>
        <form>
          <sheet>
            <group>
              <div class="oe_title">
                <label for="name" class="oe_edit_only"/>
                <h2>
                  <field name="name" class="oe_inline"/>
                </h2>
              </div>
            </group>
            <group>
              <group>
                <field name="partner_id" attrs="{'readonly': [('state', '!=', 'draft')], 'required': True}"/>
                <field name="amount" widget="monetary" attrs="{'readonly': [('state', '!=', 'draft')], 'required': True}"/>
                <field name="prestamo_id" attrs="{'readonly': True}"/>
                <field name="default_iva"/>
                <field name="vat_tax_id"/>
              </group>
              <group>
                <field name="current_user_id" invisible="1"/>
                <field name="is_change_asigned" invisible="1"/>
                <field name="comercio_id" attrs="{'readonly': True, 'required': False}"/>
                <field name="asigned_id" attrs="{'readonly': [('is_change_asigned', '!=', True)], 'required': False}"/>
                <field name="create_uid" readonly="1"/>
              </group>
            </group>
            <notebook>
              <!-- <page string="Informacion General">
                <group>
                  <group>
                    
                  </group>
                  <group>
                    
                  </group>
                </group>
              </page> -->
              <page string="Planes">
                <group>
                  <button name="wizard_seleccionar_plan" states="processing,open" class="oe_highlight" string="Seleccionar plan" type="object" groups="financiera_comercio.manager"/>
                  <button name="wizard_seleccionar_plan" states="open" class="oe_highlight" string="Seleccionar plan" type="object" groups="financiera_comercio.user"/>
                </group>
                <field name="plan_ids" readonly="1">
                  <tree>
                    <field name="nombre"/>
                    <field name="cuotas"/>
                    <field name="forma_de_pago"/>
                    <field name="total"/>
                    <field name="state"/>
                  </tree>
                </field>
              </page>
              <page string="Cuotas">
                <field name="cuota_ids">
                    <tree string="Cuotas" create="false" edit="false" delete="false">
                        <field name="numero_cuota" editable="0"/>
                        <field name="fecha_vencimiento" editable="1"/>
                        <field name="saldo_capital"/>
                        <field name="capital" sum="Total"/>
                        <field name="interes" sum="Total"/>
                        <field name="cuota_pura" sum="Total"/>
                        <field name="punitorios" invisible="0"/>
                        <field name="otros_gastos" sum="Total"/>
                        <field name="iva" sum="Total"/>
                        <field name="cobrado" sum="Total"/>
                        <field name="total" sum="Total"/>
                        <field name="saldo" sum="Total"/>
                        <field name="ultima_fecha_cobro"/>
                        <field name="state"/>
                    </tree>
                </field>
              </page>
            </notebook>
            <field name="note"/>
          </sheet>
        </form>
      </field>
    </record>

    <!-- Solicitudes a procesar -->

    <record model="ir.actions.act_window" id="solicitudes_manager_action">
      <field name="name">Solicitudes manager</field>
      <field name="res_model">financiera.solicitud</field>
      <field name="view_mode">tree,form</field>
      <!-- <field name="context">{'default_comercio_id': comercio_id}</field> -->
      <field name="context">{'search_default_pendientes':1}</field>
      <field name="domain">[('state','!=', 'draft')]</field>
      <field name="view_ids" eval="[(5, 0, 0), 
        (0, 0, {'view_mode': 'tree', 'view_id': ref('financiera_solicitud_tree')}),
        (0, 0, {'view_mode': 'form', 'view_id': ref('financiera_solicitud_form')})]
        "/>
    </record>

    <menuitem name="Solicitudes" id="menu_solicitudes_manager" web_icon="financiera_comercio,static/description/solicitud.png" groups="financiera_comercio.manager" action="solicitudes_manager_action" sequence="10"/>

    <!-- Solicitudes - Comercios -->

    <record model="ir.actions.act_window" id="solicitudes_comercio_action">
      <field name="name">Solicitudes a enviar</field>
      <field name="res_model">financiera.solicitud</field>
      <field name="view_mode">tree,form</field>
      <!-- <field name="context">{'default_comercio_id': comercio_id}</field> -->
      <field name="domain">[('create_uid','=', uid)]</field>
      <field name="view_ids" eval="[(5, 0, 0), 
        (0, 0, {'view_mode': 'tree', 'view_id': ref('financiera_solicitud_tree')}),
        (0, 0, {'view_mode': 'form', 'view_id': ref('financiera_solicitud_form')})]
        "/>
    </record>

    <menuitem name="Solicitudes" id="menu_solicitudes_comercios" groups="financiera_comercio.user" action="solicitudes_comercio_action" web_icon="financiera_comercio,static/description/solicitud.png" sequence="20"/>

  </data>
</openerp>